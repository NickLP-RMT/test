<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>üìä Report Summary - Interpreter Booking</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #f8fafc; margin: 0; }
    .container {
      max-width: 1100px;
      margin: 25px auto;
      background: #fff;
      padding: 25px 40px;
      border-radius: 12px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
      position: relative;
    }
    table {
      width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px;
    }
    th, td { padding: 10px; border-bottom: 1px solid #e2e8f0; text-align: left; }
    th { background: #f1f5f9; }
    input, select {
      padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 14px; width: 100%;
    }
    button {
      background: #007bff; color: white; padding: 10px 18px;
      border: none; border-radius: 6px; cursor: pointer; margin-top: 10px;
    }
    button:hover { background: #0056b3; }
    .form-row {
      display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-top: 15px;
    }

    /* Loading Spinner */
    #loading {
      display: none; position: absolute; inset: 0;
      background: rgba(255,255,255,0.7); backdrop-filter: blur(2px);
      justify-content: center; align-items: center; border-radius: 10px;
    }
    .spinner {
      width: 50px; height: 50px; border: 5px solid #cbd5e1;
      border-top-color: #007bff; border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>

<body>

<div id="layout"></div>

<div class="container">
  <div id="loading"><div class="spinner"></div></div>

  <h2>üìä Interpreter Report Summary</h2>

  <!-- üîç Filter Form -->
  <div class="form-row">
    <div>
      <label>Interpreter</label>
      <select id="interpreter">
        <option value="">-- Select Interpreter --</option>
        <option value="i001">SOM SAN</option>
        <option value="i002">GOOK SAN</option>
        <option value="i003">POOKY SAN</option>
        <option value="i004">L SAN</option>
      </select>
    </div>

    <div>
      <label>Start Date</label>
      <input type="date" id="startDate">
    </div>

    <div>
      <label>End Date</label>
      <input type="date" id="endDate">
    </div>
  </div>

  <button onclick="searchReport()">üîç Search</button>

  <table id="resultTable">
<thead>
  <tr>
    <th style="width: 12%;">Date</th>
    <th style="width: 8%;">Start</th>
    <th style="width: 8%;">End</th>
    <th style="width: 25%;">Title</th>
    <th style="width: 15%;">Location</th>
    <th style="width: 15%;">Interpreter</th>
    <th style="width: 15%;">User Request</th>
  </tr>
</thead>

    <tbody></tbody>
  </table>
</div>

<script>
const scriptURL = "https://script.google.com/macros/s/AKfycbzs7NdZGjjZTivIBIqR0OKRciTADISJGxQ9pGuriuwzmjaUaBng9HZfYSiqxFBQnUk/exec";

fetch("layout.html")
  .then(res => res.text())
  .then(html => {
    document.getElementById("layout").innerHTML = html;

    // Active tab = Report
    document.getElementById("tab-report").classList.add("active");

    // menu actions
    document.getElementById("tab-dashboard").onclick = () => location.href = "dashboardadmin.html";
    document.getElementById("tab-report").onclick = () => location.href = "report.html";
    document.getElementById("tab-admin").onclick = () => location.href = "admin.html";
  });


const loadingEl = document.getElementById("loading");
const showLoading = () => loadingEl.style.display = "flex";
const hideLoading = () => loadingEl.style.display = "none";

async function searchReport() {
  const interpreter = document.getElementById("interpreter").value;
  const start = document.getElementById("startDate").value;
  const end = document.getElementById("endDate").value;

  showLoading();

  try {
    const res = await fetch(`${scriptURL}?page=listBookings`);
    const data = await res.json();

    let filtered = data;

    // Filter by interpreter (optional)
    if (interpreter) {
      filtered = filtered.filter(r => r.interpreterId === interpreter);
    }

    // Filter by date range (optional)
    if (start) filtered = filtered.filter(r => r.date >= start);
    if (end)   filtered = filtered.filter(r => r.date <= end);

    // üü¶ Sort by Date ASC then StartTime ASC
    filtered.sort((a, b) => {
      const dateA = a.date.replace(/^'/, '');
      const dateB = b.date.replace(/^'/, '');
      if (dateA !== dateB) return dateA.localeCompare(dateB);

      // compare start time if date is same
      return a.startTime.localeCompare(b.startTime);
    });

    const tbody = document.querySelector("#resultTable tbody");
    tbody.innerHTML = "";

    const interpreterNames = {
      i001: "SOM SAN",
      i002: "GOOK SAN",
      i003: "POOKY SAN",
      i004: "L SAN"
    };

filtered.forEach(r => {

  // ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏° 1 ‡∏ô‡∏≤‡∏ó‡∏µ
  function addOneMinute(t) {
    if (!t || t.indexOf(":") === -1) return t;
    let [h, m] = t.split(":").map(Number);
    m++;
    if (m >= 60) { m = 0; h++; }
    if (h >= 24) h = 0; // ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÑ‡∏ß‡πâ ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏ô‡πà‡∏≤‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡πÄ‡∏•‡∏¢‡∏ñ‡∏∂‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á‡∏Ñ‡∏∑‡∏ô
    return `${String(h).padStart(2, "0")}:${String(m).padStart(2, "0")}`;
  }

  const endPlus1 = addOneMinute(r.endTime);

  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td>${r.date.replace(/^'/, '')}</td>
    <td>${r.startTime}</td>
    <td>${endPlus1}</td>   <!-- ‚úÖ ‡πÉ‡∏ä‡πâ end +1 -->
    <td>${r.title}</td>
    <td>${r.location}</td>
    <td>${interpreterNames[r.interpreterId] || r.interpreterId}</td>
    <td>${r.userEmail}</td>
  `;
  tbody.appendChild(tr);
});


  } catch (err) {
    Swal.fire("‚ùå Error", "Cannot load booking data", "error");
  } finally {
    hideLoading();
  }
}

</script>

</body>
</html>
