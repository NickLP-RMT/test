<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>Interpreter Dashboard - Resonac Booking</title>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body { margin:0; font-family:Arial,sans-serif; background:#f4f6f9; font-size:14px; }
    .navbar {
      background:#007bff; color:#fff; padding:12px 20px;
      display:flex; justify-content:space-between; align-items:center;
    }
    .navbar-right { display:flex; align-items:center; gap:12px; }
    .navbar .title { font-size:18px; font-weight:bold; }
    .navbar .user-info { font-size:13px; }
    .navbar button {
      background:#dc3545; color:#fff; border:none;
      padding:6px 12px; border-radius:4px; cursor:pointer;
      font-weight:500; transition:all 0.25s ease-in-out;
    }
    .navbar button:hover {
      background:#c82333;
      transform:scale(1.05);
      box-shadow:0 4px 8px rgba(0,0,0,0.15);
    }

    .main { display:grid; grid-template-columns:1fr 2fr; gap:20px; padding:20px; }
    .mybooking {
      background:#fff; border-radius:10px; padding:15px;
      box-shadow:0 2px 6px rgba(0,0,0,0.1); display:flex; flex-direction:column;
    }
    .job-summary { display:flex; justify-content:space-between; margin-bottom:12px; gap:10px; }
    .job-card {
      flex:1; text-align:center; padding:10px 0; border-radius:8px;
      font-weight:bold; box-shadow:0 1px 4px rgba(0,0,0,0.1);
    }
    .job-today { background:#e9f2ff; color:#007bff; }
    .job-month { background:#e9fbe9; color:#198754; }
    .mybooking-header {
      display:flex; justify-content:space-between; align-items:center;
      color:#007bff; margin-bottom:8px;
    }
    .date-nav-btn {
      background:#007bff; color:#fff; border:none;
      border-radius:5px; padding:4px 8px; font-size:12px; cursor:pointer;
      transition:background 0.2s ease;
    }
    .date-nav-btn:hover { background:#0056b3; }

    #myBookingList { max-height:480px; overflow-y:auto; padding-right:8px; }
    #myBookingList::-webkit-scrollbar { width:8px; }
    #myBookingList::-webkit-scrollbar-thumb { background:#ccc; border-radius:4px; }
    #myBookingList::-webkit-scrollbar-thumb:hover { background:#999; }

    .booking-item {
      display:flex; align-items:flex-start; border-bottom:1px solid #ddd;
      padding:8px 0; font-size:13px;
    }
    .booking-item:nth-child(even){background:#f8f9fa;}
    .booking-item:last-child{border-bottom:none;}
    .status-bar{width:6px;border-radius:4px;margin-right:10px;flex-shrink:0;}
    .booking-content{flex:1;}
    .booking-item .title{color:#007bff;font-size:14px;font-weight:bold;margin-bottom:4px;}
    .calendar-box{background:#fff; border-radius:10px; padding:15px;
      box-shadow:0 2px 6px rgba(0,0,0,0.1);}
    .badge{display:inline-block;padding:2px 8px;border-radius:6px;
      color:#fff;font-weight:bold;font-size:12px;}
    .badge.booked{background:#28a745;}
    .badge.canceled{background:#dc3545;}
    #loader{
      display:none;position:fixed;top:0;left:0;right:0;bottom:0;
      background:rgba(255,255,255,0.7);z-index:9999;
      align-items:center;justify-content:center;
    }
    #loader div{
      border:6px solid #f3f3f3;border-top:6px solid #3498db;
      border-radius:50%;width:60px;height:60px;
      animation:spin 1s linear infinite;
    }
    @keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
    .swal2-container{z-index:30000 !important;position:fixed !important;}
  </style>
</head>
<body>
  <div class="navbar">
    <div class="title">üóìÔ∏è Resonac Interpreter Booking System</div>
    <div class="navbar-right">
      <div class="user-info" id="userInfo"></div>
      <button onclick="logout()">Logout</button>
    </div>
  </div>

  <div class="main">
    <div class="mybooking">
      <div class="job-summary">
        <div class="job-card job-today" id="todayCard">üóìÔ∏è Today: 0</div>
        <div class="job-card job-month" id="monthCard">üìÜ Total This Month: 0</div>
      </div>

      <div class="mybooking-header">
        <h3 id="jobHeader">My Job (‚Äî)</h3>
        <div>
          <button class="date-nav-btn" onclick="openTakeLeave()">üèñÔ∏è Take Leave</button>
          <button class="date-nav-btn" onclick="changeDate(-1)">&lt;</button>
          <button class="date-nav-btn" onclick="goToday()">Today</button>
          <button class="date-nav-btn" onclick="changeDate(1)">&gt;</button>
        </div>
      </div>

      <div id="myBookingList"></div>
    </div>

    <div class="calendar-box">
      <iframe id="calendarFrame" src="calendar.html"
        style="width:100%; height:600px; border:none; border-radius:10px;"></iframe>
    </div>
  </div>

  <div id="loader"><div></div></div>

  <script>
    const API_URL="https://script.google.com/macros/s/AKfycbzs7NdZGjjZTivIBIqR0OKRciTADISJGxQ9pGuriuwzmjaUaBng9HZfYSiqxFBQnUk/exec";
    let currentDate=new Date();

    const INTERPRETERS = {
      i001: { name: "SOM SAN",  email: "tanapol.liampiam.xijaz@resonac.com" },
      i002: { name: "GOOK SAN", email: "boonnak.songnok.xijmk@resonac.com" },
      i003: { name: "POOKY SAN",email: "waraporn.yokao.xlbmb@resonac.com" },
      i004: { name: "L SAN",    email: "prataksara.poolsawad.xmpuh@resonac.com" }
    };
    function getInterpreterEmail(id){ return (INTERPRETERS[id] && INTERPRETERS[id].email) || ""; }
    function getInterpreterName(id){ return (INTERPRETERS[id] && INTERPRETERS[id].name) || id; }

    function showLoader(){document.getElementById("loader").style.display="flex";}
    function hideLoader(){document.getElementById("loader").style.display="none";}
    function logout(){localStorage.removeItem("loggedInUser");window.location.href="login.html";}
    function formatDate(d){return d.toISOString().split("T")[0];}
    function changeDate(o){currentDate.setDate(currentDate.getDate()+o);loadMyBookings();}
    function goToday(){currentDate=new Date();loadMyBookings();}

    async function loadMyBookings(){
      const user=JSON.parse(localStorage.getItem("loggedInUser"));
      if(!user){Swal.fire("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ Login ‡∏Å‡πà‡∏≠‡∏ô","","warning").then(()=>window.location.href="login.html");return;}
      document.getElementById("userInfo").innerText=`üë§ ${user.username} (${user.role})`;
      document.getElementById("jobHeader").innerText=`My Job (${formatDate(currentDate)})`;
      try{
        showLoader();
        const res=await fetch(API_URL+"?page=listBookings");
        const bookings=await res.json();hideLoader();
        const myBookings=bookings.filter(b=>b.interpreterEmail===user.email);
        window.allMyBookings=myBookings;
        updateSummaryCards(myBookings);
        const selected=formatDate(currentDate);
        const todays=myBookings.filter(b=>b.date===selected&&b.status!=="CANCELED")
          .sort((a,b)=>{
            const [ah,am]=a.startTime.split(":").map(Number);
            const [bh,bm]=b.startTime.split(":").map(Number);
            return ah*60+am-(bh*60+bm);
          });
        renderMyBookings(todays);
      }catch(e){hideLoader();Swal.fire("Error",e.message,"error");}
    }

    function updateSummaryCards(b){
      const today=formatDate(new Date());
      const s=new Date();s.setDate(1);
      const e=new Date(s.getFullYear(),s.getMonth()+1,0);
      const t=b.filter(x=>x.date===today&&x.status!=="CANCELED").length;
      const m=b.filter(x=>{const d=new Date(x.date);return d>=s&&d<=e&&x.status!=="CANCELED";}).length;
      document.getElementById("todayCard").innerText=`üóìÔ∏è Today: ${t}`;
      document.getElementById("monthCard").innerText=`üìÜ Total This Month: ${m}`;
    }

    function renderMyBookings(list){
      const c=document.getElementById("myBookingList");
      c.innerHTML="";
      if(!list.length){c.innerHTML="<p style='text-align:center;color:#777;'>No jobs found</p>";return;}
      list.forEach(b=>{
        const color=b.status==="BOOKED"?"booked":"canceled";
        c.innerHTML+=`
          <div class="booking-item">
            <div class="status-bar" style="background:${color==='booked'?'#28a745':'#dc3545'}"></div>
            <div class="booking-content">
              <div class="title">${b.title}</div>
              <div><b>Date(Time):</b> ${b.date} (${b.startTime}-${b.endTime})</div>
              <div><b>User:</b> ${b.userEmail||'‚Äî'}</div>
              <div><b>Status:</b> <span class="badge ${color}">${b.status}</span></div>
            </div>
          </div>`;
      });
    }

    // üèñÔ∏è Take Leave
    async function openTakeLeave(){
      const user=JSON.parse(localStorage.getItem("loggedInUser"));
      if(!user){Swal.fire("Please login first","","warning");return;}

      const { value: form } = await Swal.fire({
        title: "üèñÔ∏è Take Leave",
        html: `
          <div style='display:flex;flex-direction:column;gap:8px;text-align:left'>
            <label>Date:</label>
            <input id='leaveDate' type='date' class='swal2-input' style='width:80%'>

            <label for="timeFrom">Time From:</label>
            <select id="timeFrom" class='swal2-input' style='width:80%'>
              <option value="" disabled selected>HH:MM</option>
              <option value="07:00">07:00</option>
              <option value="07:30">07:30</option>
              <option value="08:00">08:00</option>
              <option value="08:30">08:30</option>
              <option value="09:00">09:00</option>
              <option value="09:30">09:30</option>
              <option value="10:00">10:00</option>
              <option value="10:30">10:30</option>
              <option value="11:00">11:00</option>
              <option value="11:30">11:30</option>
              <option value="12:00">12:00</option>
              <option value="12:30">12:30</option>
              <option value="13:00">13:00</option>
              <option value="13:30">13:30</option>
              <option value="14:00">14:00</option>
              <option value="14:30">14:30</option>
              <option value="15:00">15:00</option>
              <option value="15:30">15:30</option>
              <option value="16:00">16:00</option>
              <option value="16:30">16:30</option>
              <option value="17:00">17:00</option>
              <option value="17:30">17:30</option>
              <option value="18:00">18:00</option>
              <option value="18:30">18:30</option>
              <option value="19:00">19:00</option>
              <option value="19:30">19:30</option>
              <option value="20:00">20:00</option>
            </select>

            <label for="timeTo">Time To:</label>
            <select id="timeTo" class='swal2-input' style='width:80%'>
              <option value="" disabled selected>HH:MM</option>
              <option value="07:29">07:30</option>
              <option value="07:59">08:00</option>
              <option value="08:29">08:30</option>
              <option value="08:59">09:00</option>
              <option value="09:29">09:30</option>
              <option value="09:59">10:00</option>
              <option value="10:29">10:30</option>
              <option value="10:59">11:00</option>
              <option value="11:29">11:30</option>
              <option value="11:59">12:00</option>
              <option value="12:29">12:30</option>
              <option value="12:59">13:00</option>
              <option value="13:29">13:30</option>
              <option value="13:59">14:00</option>
              <option value="14:29">14:30</option>
              <option value="14:59">15:00</option>
              <option value="15:29">15:30</option>
              <option value="15:59">16:00</option>
              <option value="16:29">16:30</option>
              <option value="16:59">17:00</option>
              <option value="17:29">17:30</option>
              <option value="17:59">18:00</option>
              <option value="18:29">18:30</option>
              <option value="18:59">19:00</option>
              <option value="19:29">19:30</option>
              <option value="19:59">20:00</option>
            </select>
          </div>
        `,
        confirmButtonText: "Save",
        showCancelButton: true,
        focusConfirm: false,
        preConfirm: () => {
          const date = document.getElementById("leaveDate").value;
          const start = document.getElementById("timeFrom").value;
          const end = document.getElementById("timeTo").value;
          if (!date || !start || !end) {
            Swal.showValidationMessage("Please fill in date and time");
            return false;
          }
          return { date, start, end };
        },
      });

      if (!form) return;

      // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ß‡∏•‡∏≤‡∏ã‡πâ‡∏≥
      const existing = (window.allMyBookings || []).filter(
        (b) => b.date === form.date && b.status !== "CANCELED"
      );
      const s = parseTime(form.start),
        e = parseTime(form.end);
      const overlap = existing.some((b) => {
        const bs = parseTime(b.startTime),
          be = parseTime(b.endTime);
        return s < be && e > bs;
      });
      if (overlap) {
        Swal.fire(
          "‚ö†Ô∏è Duplicate Time",
          "You already have a booking during this period.",
          "warning"
        );
        return;
      }

try {
  showLoader();

  // ‚úÖ ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• user.id ‡πÅ‡∏•‡∏∞ email ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô dashboard.html
  const interpreterId = Object.keys(INTERPRETERS).find(
    id => INTERPRETERS[id].email === user.email
  ) || "";

  const payload = new URLSearchParams();
  payload.append("page", "newBooking");
  payload.append("userId", user.id); // ‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å user.email ‚Üí user.id
  payload.append("userEmail", user.email);
  payload.append("interpreterId", interpreterId);
  payload.append("interpreterEmail", getInterpreterEmail(interpreterId));
  payload.append("date", form.date);
  payload.append("startTime", form.start);
  payload.append("endTime", form.end);
  payload.append("title", "Take leave");
  payload.append("location", "-");
  payload.append("status", "BOOKED");
  payload.append("createdAt", new Date().toISOString());

  const res = await fetch(API_URL, { method: "POST", body: payload });
  const result = await res.json();
  hideLoader();

  if (result.success || result.status === "success") {
    Swal.fire("‚úÖ Saved!", "Your leave has been recorded.", "success");
    loadMyBookings();
    // ‚úÖ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä calendar ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡∏±‡∏ô‡∏•‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    const iframe = document.getElementById("calendarFrame");
    if (iframe) iframe.src = "calendar.html?v=" + new Date().getTime();
  } else {
    Swal.fire("Error", result.message || "Cannot save leave", "error");
  }
} catch (err) {
  hideLoader();
  Swal.fire("Error", err.message, "error");
}
} 

    function parseTime(t){const [h,m]=t.split(":").map(Number);return h*60+m;}

    loadMyBookings();
  </script>
</body>
</html>
