<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>üë©‚Äçüíº Admin Panel - Interpreter Booking</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f8fafc;
      margin: 0;
      padding: 0;
      color: #1e293b;
    }
    .navbar {
      background: linear-gradient(90deg, #007bff, #0056b3);
      color: white;
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .navbar h1 {
      font-size: 18px;
      margin: 0;
    }
    .container {
      max-width: 1100px;
      margin: 30px auto;
      background: #fff;
      padding: 25px 30px;
      border-radius: 10px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
      position: relative;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      font-size: 14px;
    }
    th, td {
      border-bottom: 1px solid #e2e8f0;
      padding: 10px;
      text-align: left;
    }
    th {
      background: #f1f5f9;
    }
    button {
      background: #007bff;
      border: none;
      color: white;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      transition: 0.25s;
    }
    button:hover { background: #0056b3; }
    .btn-secondary { background: #6b7280; }
    .btn-secondary:hover { background: #4b5563; }
    .actions { display: flex; gap: 6px; }
    input, select {
      padding: 7px 10px;
      border: 1px solid #cbd5e1;
      border-radius: 6px;
      font-size: 14px;
      width: 100%;
    }
    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit,minmax(220px,1fr));
      gap: 15px;
      margin-top: 15px;
    }
    .form-actions { margin-top: 15px; text-align: right; }

    /* üåÄ Loading Spinner */
    #loading {
      display: none;
      position: absolute;
      inset: 0;
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(2px);
      justify-content: center;
      align-items: center;
      border-radius: 10px;
    }
    .spinner {
      width: 48px;
      height: 48px;
      border: 5px solid #cbd5e1;
      border-top-color: #007bff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>

  <div class="navbar">
    <h1>Interpreter Booking - Admin</h1>
    <button onclick="loadUsers()">üîÑ Refresh</button>
  </div>

  <div class="container">
    <div id="loading"><div class="spinner"></div></div>

    <h2>üë§ User Management</h2>

    <div class="form-row">
      <div>
        <label>Username</label>
        <input id="username" placeholder="Enter username">
      </div>
      <div>
        <label>Email</label>
        <input id="email" placeholder="Enter email">
      </div>
      <div>
        <label>Password</label>
        <input id="password" placeholder="Enter password" type="password">
      </div>
      <div>
        <label>Role</label>
        <select id="role">
          <option value="user">User</option>
          <option value="admin">Admin</option>
        </select>
      </div>
    </div>
    <div class="form-actions">
      <button onclick="addUser()">‚ûï Add User</button>
    </div>

    <hr style="margin: 25px 0;">

    <h3>üìã User List</h3>
    <table id="userTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>Username</th>
          <th>Email</th>
          <th>Role</th>
          <th>Active</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbzs7NdZGjjZTivIBIqR0OKRciTADISJGxQ9pGuriuwzmjaUaBng9HZfYSiqxFBQnUk/exec"; // ‚ö†Ô∏è ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì

    const loadingEl = document.getElementById("loading");

    function showLoading() { loadingEl.style.display = "flex"; }
    function hideLoading() { loadingEl.style.display = "none"; }

    async function loadUsers() {
      showLoading();
      try {
        const res = await fetch(`${scriptURL}?page=listUsers`);
        const data = await res.json();
        const tbody = document.querySelector("#userTable tbody");
        tbody.innerHTML = "";
        data.forEach(u => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${u.id}</td>
            <td>${u.username}</td>
            <td>${u.email}</td>
            <td>${u.role}</td>
            <td>${u.active}</td>
            <td class="actions">
              <button onclick="changePasswordPrompt('${u.username}')">üîë Change Password</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        Swal.fire("‚ùå Error", "Cannot load user list", "error");
      } finally {
        hideLoading();
      }
    }

    async function addUser() {
      const username = document.getElementById("username").value.trim();
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value.trim();
      const role = document.getElementById("role").value;
      if (!username || !email || !password) {
        Swal.fire("‚ö†Ô∏è Missing info", "Please fill all fields", "warning");
        return;
      }

      const passwordHash = await sha256(password);
      const formData = new URLSearchParams();
      formData.append("page", "registerUser");
      formData.append("username", username);
      formData.append("email", email);
      formData.append("passwordHash", passwordHash);
      formData.append("role", role);

      showLoading();
      const res = await fetch(scriptURL, { method: "POST", body: formData });
      const json = await res.json();
      hideLoading();

      Swal.fire(json.success ? "‚úÖ Success" : "‚ùå Error", json.message, json.success ? "success" : "error");
      if (json.success) loadUsers();
    }

    async function changePasswordPrompt(username) {
      const { value: newPassword } = await Swal.fire({
        title: `üîë Change Password for ${username}`,
        input: "password",
        inputPlaceholder: "Enter new password",
        inputAttributes: { autocapitalize: "off" },
        showCancelButton: true,
        confirmButtonText: "Update",
        cancelButtonText: "Cancel",
        confirmButtonColor: "#007bff"
      });

      if (!newPassword) return;

      const passwordHash = await sha256(newPassword);
      const formData = new URLSearchParams();
      formData.append("page", "updatePassword");
      formData.append("username", username);
      formData.append("passwordHash", passwordHash);

      showLoading();
      const res = await fetch(scriptURL, { method: "POST", body: formData });
      const json = await res.json();
      hideLoading();

      Swal.fire(json.success ? "‚úÖ Success" : "‚ùå Error", json.message, json.success ? "success" : "error");
    }

    async function sha256(message) {
      const msgBuffer = new TextEncoder().encode(message);
      const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    window.onload = loadUsers;
  </script>
</body>
</html>
